#user web;
worker_processes 1;
pid /app/conf/nginx.pid;
error_log /app/log/error.log;

events {
  worker_connections 20000;
}

http {
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;
  types_hash_max_size 2048;
  server_tokens off;

  include /etc/nginx/mime.types;
  types {
    application/vnd.apple.pkpass pkpass;
    font/ttf ttf;
    application/vnd.ms-fontobject eot;
  }
  default_type application/octet-stream;

  access_log /app/log/access.log combined;

  # Set $remote_addr from our X-Client-IP header.
  # This is a bad idea when facing the outside world, but this header is enforced by the platform.
  real_ip_header X-Client-IP;
  set_real_ip_from 0.0.0.0/0;

  # Force nginx to only generate relative redirects.
  absolute_redirect off;

  # Tracking headers.
  more_set_headers "X-Platform-nginx: custom nginx";
  # Remove the server header completely.
  more_set_headers "Server:";


  # Disable buffering of the *request* (\o/ thanks nginx 1.7.1).
  proxy_request_buffering off;
  fastcgi_request_buffering off;
  # Do not limit the body size.
  client_max_body_size 0;
  client_body_buffer_size 128k;

  # Enable in-memory buffering of the *response*.
  proxy_buffering on;
  fastcgi_buffering on;
  # Increase the size of the initial buffer, used to read the response header.
  proxy_buffer_size 32k;
  fastcgi_buffer_size 32k;
  proxy_buffers 128 4k;
  fastcgi_buffers 128 4k;
  proxy_busy_buffers_size 32k;
  fastcgi_busy_buffers_size 32k;
  # Disable on-disk buffering.
  proxy_max_temp_file_size 0;
  fastcgi_max_temp_file_size 0;

  # Timeouts.
  # We timeout after 30s if the application cannot start processing the request...
  proxy_connect_timeout     30s;
  fastcgi_connect_timeout   30s;
  # ... but once the application started processing, we essentially never timeout.
  proxy_read_timeout        86400s;
  fastcgi_read_timeout      86400s;
  proxy_send_timeout        86400s;
  fastcgi_send_timeout      86400s;

  # Ignore all special upstream headers.
  proxy_ignore_headers X-Accel-Redirect X-Accel-Expires X-Accel-Limit-Rate
    X-Accel-Buffering X-Accel-Charset Expires Cache-Control Set-Cookie Vary;
  fastcgi_ignore_headers X-Accel-Redirect X-Accel-Expires X-Accel-Limit-Rate
    X-Accel-Buffering X-Accel-Charset Expires Cache-Control Set-Cookie Vary;

  client_body_temp_path /tmp/appnginx/client_temp;
  proxy_temp_path /tmp/appnginx/proxy_temp;
  fastcgi_temp_path /tmp/appnginx/fastcgi_temp;
  uwsgi_temp_path /tmp/appnginx/uwsgi_temp;
  scgi_temp_path /tmp/appnginx/scgi_temp;

  map $http_x_client_ssl $platform_server_port {
    "on"      443;
    default   80;
  }

  # If the request has a Upgrade header, set Connection to "upgrade",
  # else force it as "Connection: close" to force the upstream to close the
  # connection.
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  server {
    # PORT comes from envsubst executed in deploy hook.
    # HTTPS is terminated on the edge.
    listen ${PORT} default_server;


    gzip_static on;
    gzip_http_version 1.0;
    gzip_proxied any;
    gzip_vary on;
    gzip_comp_level 1;
    gzip_types application/ecmascript application/javascript application/json;
    gzip_types application/pdf application/postscript application/x-javascript;
    gzip_types image/svg+xml text/css text/csv text/javascript text/plain text/xml;

    brotli_static on;
    brotli_comp_level 3;  # Equivalent to gzip level 1, but often with a higher compression ratio.
    brotli_types application/ecmascript application/javascript application/json;
    brotli_types application/pdf application/postscript application/x-javascript;
    brotli_types image/svg+xml text/css text/csv text/javascript text/plain text/xml;

    #location "/" {
        #proxy_set_header X-Real-IP $remote_addr;
        #proxy_pass http://app.internal/;
        #auth_basic           “Administrator’s Area”;
        #auth_basic_user_file /app/.htpasswd;
    #}

    # To improve the perf, let's use open_file_cache
    # ref: nginx.org/r/open_file_cache
    # open_file_cache               max=1000;
    # open_file_cache_valid     60s;
    # open_file_cache_min_uses  2;
    # open_file_cache_errors        off;

    location / {
        proxy_set_header X-Real-IP $remote_addr;
        proxy_pass http://app.internal/;
        # Proxy headers
        #proxy_set_header Upgrade           $http_upgrade;
        #proxy_set_header Connection        "upgrade";
        #proxy_set_header Host              $host;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        #proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host  $host;
        #proxy_set_header X-Forwarded-Port  $server_port;
        # disable WP Rocket preload bot; had numerous trouble with in on high-traffic sites
        if ($http_user_agent ~ wprocketbot) { return 403; access_log off; }

        error_page 418 = @cachemiss;
        error_page 419 = @mobileaccess;
        recursive_error_pages on;

        # bypass POST requests
        if ($request_method = POST) { return 418; }

        # uncommenting the following degrades the performance on certain sites. YMMV
        # if ($query_string != "") { return 418; }

        # bypass cache for common query strings
        if ($arg_s != "") { return 418; } # search query
        if ($arg_p != "") { return 418; } # request a post / page by ID
        if ($args ~ "amp") { return 418; } # amp test
        if ($arg_preview = "true") { return 418; } # preview post / page
        if ($arg_ao_noptimize != "") { return 418; } # support for Autoptimize plugin

        if ($http_cookie ~* "wordpress_logged_in_") { return 418; }
        if ($http_cookie ~* "comment_author_") { return 418; }
        if ($http_cookie ~* "wp_postpass_") { return 418; }

        # avoid duplicate content on Amazon CloudFront and KeyCDN.
        if ( $http_user_agent = "Amazon CloudFront" ) { return 403; access_log off; }
        if ($http_x_pull = "KeyCDN") { return 403; access_log off; }

        # uncomment the following, if WP Rocket plugin is set to create a separate cache for mobile visitors
        # if ($http_user_agent ~* "2.0\ MMP|240x320|400X240|AvantGo|BlackBerry|Blazer|Cellphone|Danger|DoCoMo|Elaine/3.0|EudoraWeb|Googlebot-Mobile|hiptop|IEMobile|KYOCERA/WX310K|LG/U990|MIDP-2.|MMEF20|MOT-V|NetFront|Newt|Nintendo\ Wii|Nitro|Nokia|Opera\ Mini|Palm|PlayStation\ Portable|portalmmm|Proxinet|ProxiNet|SHARP-TQ-GX10|SHG-i900|Small|SonyEricsson|Symbian\ OS|SymbianOS|TS21i-10|UP.Browser|UP.Link|webOS|Windows\ CE|WinWAP|YahooSeeker/M1A1-R2D2|iPhone|iPod|Android|BlackBerry9530|LG-TU915\ Obigo|LGE\ VX|webOS|Nokia5800|iPad") { return 419; }
        # add_header "Vary" "User-Agent";

        # uncomment the following if deemed fit, in addition to the above line to enable @mobileaccess
        # if ($http_user_agent ~* "w3c\ |w3c-|acs-|alav|alca|amoi|audi|avan|benq|bird|blac|blaz|brew|cell|cldc|cmd-|dang|doco|eric|hipt|htc_|inno|ipaq|ipod|jigs|kddi|keji|leno|lg-c|lg-d|lg-g|lge-|lg/u|maui|maxo|midp|mits|mmef|mobi|mot-|moto|mwbp|nec-|newt|noki|palm|pana|pant|phil|play|port|prox|qwap|sage|sams|sany|sch-|sec-|send|seri|sgh-|shar|sie-|siem|smal|smar|sony|sph-|symb|t-mo|teli|tim-|tosh|tsm-|upg1|upsi|vk-v|voda|wap-|wapa|wapi|wapp|wapr|webc|winw|winw|xda\ |xda-|ipad") { return 419; }

        try_files "/wp-content/cache/wp-rocket/$host${uri}$is_args$args/index$https_suffix.html" $uri $uri/ /index.php$is_args$args;

        #--> all the following would apply, only if the request hits the cache

        add_header "X-Cache" "HIT - WP Rocket";
        add_header "Vary" "Cookie";
        # include "globals/hsts.conf";
        include 'globals/security-headers.conf';

        expires modified 30m;
        add_header "Cache-Control" "must-revalidate";

        # For proxies
        # add_header "Cache-Control" "s-maxage=600";
    }

    location @mobileaccess {
        # try_files $uri $uri/ /index.php$is_args$args;
        try_files "/wp-content/cache/wp-rocket/$host${uri}$is_args$args/index-mobile$https_suffix.html" $uri $uri/ /index.php$is_args$args;

        add_header "X-Cache" "HIT - Mobile - WP Rocket";
        add_header "Vary" "User-Agent, Cookie";
        # include "globals/hsts.conf";
        include 'globals/security-headers.conf';

        expires modified 30m;
        add_header "Cache-Control" "must-revalidate";

        # For proxies
        # add_header "Cache-Control" "s-maxage=600";
    }

    location @cachemiss {
        try_files $uri $uri/ /index.php$is_args$args;
    }

    # Error pages.
    error_page 400 /_/errors/400.html;
    error_page 401 /_/errors/401.html;
    error_page 402 /_/errors/402.html;
    error_page 403 /_/errors/403.html;
    error_page 404 /_/errors/404.html;
    error_page 405 /_/errors/405.html;
    error_page 406 /_/errors/406.html;
    error_page 408 /_/errors/408.html;
    error_page 409 /_/errors/409.html;
    error_page 410 /_/errors/410.html;
    error_page 411 /_/errors/411.html;
    error_page 412 /_/errors/412.html;
    error_page 413 /_/errors/413.html;
    error_page 414 /_/errors/414.html;
    error_page 415 /_/errors/415.html;
    error_page 416 /_/errors/416.html;
    error_page 421 /_/errors/421.html;
    error_page 494 /_/errors/494.html;
    error_page 495 /_/errors/495.html;
    error_page 496 /_/errors/496.html;
    error_page 497 /_/errors/497.html;
    error_page 500 /_/errors/500.html;
    error_page 501 /_/errors/501.html;
    error_page 502 /_/errors/502.html;
    error_page 503 /_/errors/503.html;
    error_page 504 /_/errors/504.html;
    error_page 507 /_/errors/507.html;

    location "/_/errors" {
      internal;
      alias /run/errors;
    }
  }
}
